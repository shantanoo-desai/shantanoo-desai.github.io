<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>How Reproducibility + Documentation in Software goes deep: Practical Scenario - Shan's Corner</title><meta name=Description content="Shan's World"><meta property="og:title" content="How Reproducibility + Documentation in Software goes deep: Practical Scenario"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:url" content="https://shantanoo-desai.github.io/posts/technology/reproducibility_docker/"><meta property="article:published_time" content="2023-06-11T20:00:00+02:00"><meta property="article:modified_time" content="2023-06-11T20:00:00+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="How Reproducibility + Documentation in Software goes deep: Practical Scenario"><meta name=twitter:description content><meta name=application-name content="Shan's World"><meta name=apple-mobile-web-app-title content="Shan's World"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://shantanoo-desai.github.io/posts/technology/reproducibility_docker/><link rel=prev href=https://shantanoo-desai.github.io/posts/technology/containers-to-os/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"How Reproducibility + Documentation in Software goes deep: Practical Scenario","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/shantanoo-desai.github.io\/posts\/technology\/reproducibility_docker\/"},"genre":"posts","keywords":"docker, docker-compose, vagrant, ansible, DevOps","wordcount":1228,"url":"https:\/\/shantanoo-desai.github.io\/posts\/technology\/reproducibility_docker\/","datePublished":"2023-06-11T20:00:00+02:00","dateModified":"2023-06-11T20:00:00+02:00","publisher":{"@type":"Organization","name":"Shan"},"author":{"@type":"Person","name":"Shan"},"description":""}</script></head><body header-desktop header-mobile><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Shan's Corner">Shan's Corner</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/now title="What am I currently focusing on">Now </a><a class=menu-item href=/posts/ title="My thoughts and works digitally transcribed">Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/about/ title="Everything You wish to know about me">About </a><a class=menu-item href=/categories/>Categories </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Shan's Corner">Shan's Corner</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/now title="What am I currently focusing on">Now</a><a class=menu-item href=/posts/ title="My thoughts and works digitally transcribed">Posts</a><a class=menu-item href=/tags/>Tags</a><a class=menu-item href=/about/ title="Everything You wish to know about me">About</a><a class=menu-item href=/categories/>Categories</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">How Reproducibility + Documentation in Software goes deep: Practical Scenario</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Shan</a></span>&nbsp;<span class=post-category>included in <a href=/categories/technology/><i class="far fa-folder fa-fw"></i>Technology</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=11-06-2023>11-06-2023</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1228 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;6 minutes&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#problem>Problem</a><ul><li><a href=#hackin-around>Hackin&rsquo; Around</a></li></ul></li><li><a href=#reporting-the-behaviour>Reporting the Behaviour</a><ul><li><a href=#dread-of-it-works-on-my-machine-cant-reproduce-it>Dread of &ldquo;It works on my machine, can&rsquo;t reproduce it&rdquo;</a></li><li><a href=#one-last-effort>One Last Effort!</a></li></ul></li><li><a href=#isolate-compare-determine>Isolate, Compare, Determine!</a><ul><li><a href=#documenting-the-discrepancy>Documenting the Discrepancy!</a></li></ul></li><li><a href=#inference>Inference</a></li></ul></nav></div></div><div class=content id=content><h2 id=problem>Problem</h2><p>I have been working on a personal project which I recently open-sourced called <a href=https://github.com/shantanoo-desai/komponist target=_blank rel="noopener noreffer">Komponist</a>.
In a nutshell, the project is heavily reliant on some of the most widely used tools today in
the software landscape i.e., <strong>Ansible</strong>, <strong>Docker</strong>, <strong>Docker Compose</strong>.</p><p>Everything was <em>smooth-sailing</em> with a new feature planned when suddenly I started getting a
strange error when bringing my container stack up using:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>docker compose --project-directory<span class=o>=</span>deploy up -d
</code></pre></div><p>The error was rather mysterious and not much verbose. It screamed something like:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>Error response from daemon: Could not find the file / in container &lt;container_id&gt;
</code></pre></div><p>This seemed rather odd, the same thing that worked a couple of days back now is rendered
buggy! As usual common searches didn&rsquo;t lead me anywhere. What was rather weird was the fact that
I never was mounting any root directory anywhere (<code>/</code>). The good thing about this error was
I had only two realms to look into, either <strong>Docker Compose v2</strong> tool or the <strong>Docker Engine</strong></p><h3 id=hackin-around>Hackin&rsquo; Around</h3><p>Since this was a sudden bug that I faced with, I suspected initially something going wrong with
the Compose Files (<code>docker-compose.yml</code>) file which my tool generates. However, this felt rather
counter-intuitive because the tool itself also takes up the initiative to validate all my Compose Files.
Had there been any error, the validation logic would have failed and hence would not have generated me
a production-ready file in the first place.</p><p>Through some previous recollections, I was conscious about User ID within the container causing problems
especially when trying to mount secrets into Docker Containers. In essence, my tool mounts Secrets (credentials)
into the container via Docker Compose&rsquo;s specification which copies the values under the <code>/run/secrets</code> directory
within a container.</p><p>This feature, although great had some small caveats. As security best-practice most containers have a user within
them, which does <em>NOT</em> have enough privileges to actually mount the secrets into the <code>/run/secrets</code> directory.
The only exception being container with <code>root</code> user (which is generally not the best idea in the first place).</p><p>A common fix is to add <code>user</code> parameter to each service with the current Host&rsquo;s User ID, e.g., <code>1000</code> which
will run the container as the same user ID as that of the host&rsquo;s user. This was already part of the current system
in my project.</p><p>I started hacking around thinking this particular value might be the main culprit so I tried adding
various combinations like <code>user: "1000:1000"</code> or <code>user: "&lt;my_host-machine_name>"</code> but it did not work.</p><p>A last dumpster dive into some GitHub Issues on the <a href=https://github.com/moby/moby target=_blank rel="noopener noreffer">Moby Project</a> which is essentially the Docker Engine
landed me onto <a href=https://github.com/moby/moby/issues/34142 target=_blank rel="noopener noreffer">Issue 34142 for Moby Project</a> which is open since <strong>2017</strong> (yes you read that right!).</p><p>At wit&rsquo;s end, I thought if the user on my host has stopped working, I might as well give the user within the image
a shot i.e., if I have a Grafana container, upon running:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ docker run -it grafana/grafana-oss:latest whoami
grafana
</code></pre></div><p>so updating my <code>user</code> parameter to <code>user: "grafana"</code> suddenly brought got everything working!</p><blockquote><p>Temporary fix for the Project! Hurrah!</p></blockquote><h2 id=reporting-the-behaviour>Reporting the Behaviour</h2><p>I generally am very thorough in reporting bugs / issues to Open-Source Projects. Essentially I start
with mentioning my Host, all the software versions that are affected (here, Docker Engine / Docker Compose v2)
and provide a Minimum Example that can be reproduced by anyone. Since the fix was pertaining to Docker Compose v2&rsquo;s
<code>user</code> property I reported a bug on <a href=https://github.com/docker/compose/issues/10663 target=_blank rel="noopener noreffer">Github&rsquo;s docker/compose repo</a>.</p><p>The Maintainers had a look into it, but then came the nightmare answer of:</p><blockquote><p>Tried to reproduce it, I got something else !</p></blockquote><h3 id=dread-of-it-works-on-my-machine-cant-reproduce-it>Dread of &ldquo;It works on my machine, can&rsquo;t reproduce it&rdquo;</h3><p>After a few back and forth with the maintainer and even trying out certain examples, it felt like I had messed up
my Docker Enginer with some configuration. It wasn&rsquo;t the case, since my configuration file was the least bit
complicated and it was close to running an <em>out-of-the-box</em> Docker Engine.</p><p>It seemed like this was going to be one of those GitHub Issues that would be left open and gets lost in the
Oblivion of Open-Source Projects. Everything seemed haywired.</p><h3 id=one-last-effort>One Last Effort!</h3><p>Whilst the back and forth between my Bug report and the Maintainer&rsquo;s non-reproducible errors started to reduce,
I reverted back to the an older Docker Engine Version to see if a sudden update started to cause this error on my end.</p><p>For Context, the Issue was about using <strong>Docker Engine v24.x</strong> with <strong>Docker Compose v2.18.1</strong>. I downgraded the
Docker Engine to the last <strong>v23.x.x</strong> and would you know it! Things started to work again.</p><p>I was able to pinpoint out that things were going wrong, since the <em>leap of faith</em> from Docker Engine <strong>v23</strong> to <strong>v24</strong>.
I mentioned this difference in the <a href=https://github.com/docker/compose/issues/10663#issuecomment-1580624862 target=_blank rel="noopener noreffer">Issue&rsquo;s Thread</a></p><p>So I was convinced that something is breaking between the Docker Engine versions but I wasn&rsquo;t sure whether there was
some discrepancy in Docker Compose v2 too.</p><p>This led me to a previous Compatibility Anaylyses that I had done about a year back called
<a href=https://shantanoo-desai.github.io/posts/technology/compose-incompatibility/ target=_blank rel="noopener noreffer">Exploring the Marshland: Docker Compose Versions</a>
where I was able to isolate different versions of the software to determine which versions were working with what
specific paramters. The tool I had used was <strong>Vagrant</strong>.</p><h2 id=isolate-compare-determine>Isolate, Compare, Determine!</h2><p>I took the initiative of creating two <strong>Isolated Vagrant Boxes</strong> with the following softwares:</p><table><thead><tr><th align=center>Vagrant Box</th><th align=center>Docker Engine Version</th><th align=center>Docker Compose Version(s)</th></tr></thead><tbody><tr><td align=center><strong>Box 1</strong></td><td align=center><code>v23.0.6</code></td><td align=center><code>v2.18.1</code> <code>v2.17.3</code> <code>v2.16.0</code></td></tr><tr><td align=center><strong>Box 2</strong></td><td align=center><code>v24.0.2</code></td><td align=center><code>v2.18.1</code> <code>v2.17.3</code> <code>v2.16.0</code></td></tr></tbody></table><h3 id=documenting-the-discrepancy>Documenting the Discrepancy!</h3><p>I dediced that I would rather add GIFs of the reproductiong of the errors as opposed to adding a lot of
verbosity to an already complicated problem and create a repo that would reduce the time for the Bug reproduction.
This does come with an assumption that the Maintainer would also have <strong>Vagrant</strong> or something similar to test at their
end.</p><p>I was able to reproduce the same bugs in a rather isolated environment using Vagrant disproving my theory that I had
messed my Docker Engine up and perhaps the Maintainer should try the stuff out again at their end.</p><p>The Repo can be Found on <a href=https://github.com/shantanoo-desai/docker-engine-secrets-error target=_blank rel="noopener noreffer">GitHub</a></p><h2 id=inference>Inference</h2><p>Upon providing an environment to reproduce this error as well as some GIF documentation, it turned out that this was
actually an error even the Maintainer can reproduce. This error is related to the Docker Engine v24 and not Docker Compose v2
and it is now being tracked with fixes already on the way.
See <a href=https://github.com/moby/moby/issues/45719 target=_blank rel="noopener noreffer">Moby/Moby Issue #45719</a>.</p><p>This might look like a lot of work, which in hindsight might be, but it is worth being comfortable with tools where a decent
amount of reproducibility via Isolation can provide a strong foundation to look into software a bit more deeper!</p><p>Vagrant is meant to be Developer-Friendly tool which indeed helped me overcome the dreadful situation of</p><blockquote><p>It worked on my machine, why isn&rsquo;t it working on yours?!</p></blockquote><p>It also helped collaborate on a problem which stemmed not in Docker Compose v2 but went all the way down to Docker Engine
itself. The maintainer was able to produce the same error with <a href=https://multipass.run/ target=_blank rel="noopener noreffer">Canonical&rsquo;s multipass</a> which also
reached the same goal through a different route.</p><p>So in a nutshell, a few hours of going in the deep end of error reproducibility may feel like time wasted but it might
just solve a problem that is long-lasting (till something new pops up!)</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 11-06-2023</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://shantanoo-desai.github.io/posts/technology/reproducibility_docker/ data-title="How Reproducibility + Documentation in Software goes deep: Practical Scenario" data-hashtags=docker,docker-compose,vagrant,ansible,DevOps><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://shantanoo-desai.github.io/posts/technology/reproducibility_docker/ data-hashtag=docker><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://shantanoo-desai.github.io/posts/technology/reproducibility_docker/><i class="fab fa-linkedin fa-fw"></i></a><a href=javascript:void(0); title="Share on WhatsApp" data-sharer=whatsapp data-url=https://shantanoo-desai.github.io/posts/technology/reproducibility_docker/ data-title="How Reproducibility + Documentation in Software goes deep: Practical Scenario" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://shantanoo-desai.github.io/posts/technology/reproducibility_docker/ data-title="How Reproducibility + Documentation in Software goes deep: Practical Scenario"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://shantanoo-desai.github.io/posts/technology/reproducibility_docker/><i class="fab fa-reddit fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/docker/>docker</a>,&nbsp;<a href=/tags/docker-compose/>docker-compose</a>,&nbsp;<a href=/tags/vagrant/>vagrant</a>,&nbsp;<a href=/tags/ansible/>ansible</a>,&nbsp;<a href=/tags/devops/>DevOps</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/technology/containers-to-os/ class=prev rel=prev title="Build a Bootable OS with Docker Containers using Hashicorp Packer"><i class="fas fa-angle-left fa-fw"></i>Build a Bootable OS with Docker Containers using Hashicorp Packer</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.70.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{}};</script><script type=text/javascript src=/js/theme.min.js></script></body></html>