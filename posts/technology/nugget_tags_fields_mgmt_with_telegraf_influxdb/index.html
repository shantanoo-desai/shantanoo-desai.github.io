<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Nugget: Let Telegraf manage your InfluxDB Fields and Tags for you - Shan's Corner</title><meta name=Description content="Map your fields to distinct values and replace them as tags for InfluxDB"><meta property="og:title" content="Nugget: Let Telegraf manage your InfluxDB Fields and Tags for you"><meta property="og:description" content="Map your fields to distinct values and replace them as tags for InfluxDB"><meta property="og:type" content="article"><meta property="og:url" content="https://shantanoo-desai.github.io/posts/technology/nugget_tags_fields_mgmt_with_telegraf_influxdb/"><meta property="article:published_time" content="2020-09-03T14:38:09+02:00"><meta property="article:modified_time" content="2020-09-03T14:38:09+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Nugget: Let Telegraf manage your InfluxDB Fields and Tags for you"><meta name=twitter:description content="Map your fields to distinct values and replace them as tags for InfluxDB"><meta name=application-name content="Shan's World"><meta name=apple-mobile-web-app-title content="Shan's World"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://shantanoo-desai.github.io/posts/technology/nugget_tags_fields_mgmt_with_telegraf_influxdb/><link rel=prev href=https://shantanoo-desai.github.io/posts/technology/questitto_light_stack_for_iot/><link rel=next href=https://shantanoo-desai.github.io/posts/technology/nugget_mosquitto_docker_persistence_without_sudo/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Nugget: Let Telegraf manage your InfluxDB Fields and Tags for you","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/shantanoo-desai.github.io\/posts\/technology\/nugget_tags_fields_mgmt_with_telegraf_influxdb\/"},"genre":"posts","keywords":"MQTT, IoT, Telegraf, InfluxDB","wordcount":557,"url":"https:\/\/shantanoo-desai.github.io\/posts\/technology\/nugget_tags_fields_mgmt_with_telegraf_influxdb\/","datePublished":"2020-09-03T14:38:09+02:00","dateModified":"2020-09-03T14:38:09+02:00","publisher":{"@type":"Organization","name":"Shan"},"author":{"@type":"Person","name":"Shan"},"description":"Map your fields to distinct values and replace them as tags for InfluxDB"}</script></head><body header-desktop header-mobile><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Shan's Corner">Shan's Corner</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/ title="My thoughts and works digitally transcribed">Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/ title="Everything You wish to know about me">About </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Shan's Corner">Shan's Corner</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title="My thoughts and works digitally transcribed">Posts</a><a class=menu-item href=/tags/>Tags</a><a class=menu-item href=/categories/>Categories</a><a class=menu-item href=/about/ title="Everything You wish to know about me">About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Nugget: Let Telegraf manage your InfluxDB Fields and Tags for you</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Shan</a></span>&nbsp;<span class=post-category>included in <a href=/categories/technology/><i class="far fa-folder fa-fw"></i>Technology</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=03-09-2020>03-09-2020</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;557 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;3 minutes&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#requirement>Requirement</a></li><li><a href=#who-you-gonna-call---telegraf>Who You gonna call ðŸ“ž? &mldr;. Telegraf</a></li><li><a href=#complete-configuration-file>Complete Configuration File</a><ul><li><a href=#deployment-via-docker>Deployment via Docker</a></li></ul></li><li><a href=#conclusions>Conclusions</a></li></ul></nav></div></div><div class=content id=content><h2 id=overview>Overview</h2><p>Assume that some data is arriving to my Acquisition system in the form of the following JSON schema:</p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>
    <span class=nt>&#34;name&#34;</span><span class=p>:</span><span class=s2>&#34;systemStatus&#34;</span><span class=p>,</span>
    <span class=nt>&#34;timestamp&#34;</span><span class=p>:</span> <span class=s2>&#34;2020-09-02 13:10:00.000&#34;</span><span class=p>,</span>
    <span class=nt>&#34;result&#34;</span><span class=p>:</span> <span class=s2>&#34;GOOD&#34;</span>
<span class=p>}</span>
</code></pre></div><p>In my case, the data is published to an MQTT Broker with the above mentioned JSON data as payload to a topic:</p><pre><code>PROJ/system/status
</code></pre><h2 id=requirement>Requirement</h2><p>The following are the requirements:</p><ol><li>store the incoming JSON payload in InfluxDB</li><li>instead of storing <code>GOOD</code> and <code>BAD</code> as fields, map them as <code>GOOD -> 0</code> and <code>BAD -> 1</code> where <code>result</code> should be stored as a <code>tag</code> and <code>value</code> (either <code>0</code> or <code>1</code>) should be stored as <code>field</code></li></ol><p>Theoretically the <strong>InfluxDB Line Protocol String</strong> should look like:</p><pre><code>systemStatus,result=&quot;GOOD&quot; value=0 1599052200000
systemStatus,result=&quot;BAD&quot; value=1 1599052200000
</code></pre><p>So Queries to other software components can be simply:</p><pre><code>SELECT value from PROJ.autogen.systemStatus where result='GOOD'
</code></pre><h2 id=who-you-gonna-call---telegraf>Who You gonna call ðŸ“ž? &mldr;. Telegraf</h2><p>Here is how I solved the requirement:</p><ol><li><p>Connect <code>telegraf</code> to your MQTT Broker using the <code>[[inputs.mqtt_consumer]]</code> plugin and subscribe to the <code>PROJ/system/status</code> topic</p></li><li><p>Use the <code>json</code> as the incoming data format. Telegraf Provides a wide range of <a href=https://github.com/influxdata/telegraf/blob/master/docs/DATA_FORMATS_INPUT.md target=_blank rel="noopener noreffer">Input Data Format</a></p><pre><code>  data_format = &quot;json&quot;
</code></pre><p>a. Use the <code>name</code> key of the JSON Payload as the Measurement Name using:</p><pre><code>     json_name_key = &quot;name&quot;
</code></pre><p>b. Store the <code>result</code> key of the payload as a field for the time being and make sure to store it as a <code>string</code>. For that simply use:</p><pre><code>     json_string_fields = [&quot;result&quot;]
</code></pre><p>c. Use the <code>timestamp</code> key of the payload to store the timestamp with <a href=https://yourbasic.org/golang/format-parse-string-time-date-example/ target=_blank rel="noopener noreffer">Golang Format</a> as follows:</p><pre><code>      json_time_format = &quot;2006-01-02 15:04:05.000&quot;
      json_time_key = &quot;timestamp&quot;
</code></pre><p>TOML Config:</p><div class=highlight><pre class=chroma><code class=language-toml data-lang=toml>    <span class=p>[[</span><span class=nx>inputs</span><span class=p>.</span><span class=nx>mqtt_consumer</span><span class=p>]]</span>

        <span class=nx>servers</span> <span class=p>=</span> <span class=p>[</span> <span class=s2>&#34;ssl://MY_MQTT_BROKER:8883&#34;</span> <span class=p>]</span>

        <span class=c># Topics to subscribe to:</span>
        <span class=nx>topics</span> <span class=p>=</span> <span class=p>[</span>
            <span class=s2>&#34;PROJ/system/status&#34;</span>
        <span class=p>]</span>

        <span class=c># User Credentials and TLS Settings go here.</span>

        <span class=c># Incoming MQTT Payload is in JSON format with fixed schema</span>
        <span class=nx>data_format</span> <span class=p>=</span> <span class=s2>&#34;json&#34;</span>

        <span class=nx>json_name_key</span> <span class=p>=</span> <span class=s2>&#34;name&#34;</span>
        <span class=nx>json_string_fields</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;result&#34;</span><span class=p>]</span>
        <span class=nx>json_time_format</span> <span class=p>=</span> <span class=s2>&#34;2006-01-02 15:04:05.000&#34;</span>
        <span class=nx>json_time_key</span> <span class=p>=</span> <span class=s2>&#34;timestamp&#34;</span>
</code></pre></div></li><li><p>Connect <code>telegraf</code> to your InfluxDB Instance using the <code>[[outputs.influxdb]]</code> or <code>[[outputs.influxdb_v2]]</code> plugin</p><p>TOML Config:</p><div class=highlight><pre class=chroma><code class=language-toml data-lang=toml>
    <span class=p>[[</span><span class=nx>outputs</span><span class=p>.</span><span class=nx>influxdb</span><span class=p>]]</span>

    <span class=nx>urls</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;https://&lt;MY_INFLUXDBV1_INSTANCE:8086&#34;</span><span class=p>]</span>
    <span class=nx>database</span> <span class=p>=</span> <span class=s2>&#34;PROJ&#34;</span>
    <span class=nx>skip_database_creation</span> <span class=p>=</span> <span class=kc>false</span>
       
    <span class=c># User Credentials + TLS Verify settings go here</span>
</code></pre></div></li><li><p><strong>JUICY PART</strong>: Time to leverage the <code>processors</code> plugin to achieve our task:</p><p>a. Let&rsquo;s first use <code>enum</code> to map the respective values i.e. <code>GOOD -> 0</code> and <code>BAD -> 1</code> on our already available field <code>result</code>:</p><p>TOML Config:</p><div class=highlight><pre class=chroma><code class=language-toml data-lang=toml>    <span class=p>[[</span><span class=nx>processors</span><span class=p>.</span><span class=nx>enum</span><span class=p>]]</span>
        <span class=nx>order</span> <span class=p>=</span> <span class=mi>1</span>
    <span class=p>[[</span><span class=nx>processors</span><span class=p>.</span><span class=nx>enum</span><span class=p>.</span><span class=nx>mapping</span><span class=p>]]</span>
        <span class=nx>field</span> <span class=p>=</span> <span class=s2>&#34;result&#34;</span>
        <span class=nx>dest</span> <span class=p>=</span> <span class=s2>&#34;value&#34;</span>
        <span class=p>[</span><span class=nx>processors</span><span class=p>.</span><span class=nx>enum</span><span class=p>.</span><span class=nx>mapping</span><span class=p>.</span><span class=nx>value_mappings</span><span class=p>]</span>
            <span class=s2>&#34;GOOD&#34;</span> <span class=p>=</span> <span class=mi>0</span>
            <span class=s2>&#34;BAD&#34;</span>  <span class=p>=</span> <span class=mi>1</span>
</code></pre></div><p>This configuration will be executed first due to <code>order=1</code> and will map out field <code>result</code> to their respective numeric values into another field called <code>value</code></p><p>At this point, the Line Protocol String should look similar to:</p><pre><code> systemStatus result=&quot;GOOD&quot;,value=0.0 1599052200000
 systemStatus result=&quot;BAD&quot;,value=1.0 1599052200000
</code></pre><p>b. Let&rsquo;s use another <code>processors</code> plugin called <code>converter</code> to convert our field <code>result</code> into a tag.</p><p>TOML Config:</p><div class=highlight><pre class=chroma><code class=language-toml data-lang=toml>    <span class=p>[[</span><span class=nx>processors</span><span class=p>.</span><span class=nx>converter</span><span class=p>]]</span>
        <span class=nx>order</span> <span class=p>=</span> <span class=mi>2</span>
        <span class=p>[</span><span class=nx>processors</span><span class=p>.</span><span class=nx>converter</span><span class=p>.</span><span class=nx>fields</span><span class=p>]</span>
            <span class=nx>tag</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;result&#34;</span><span class=p>]</span>
</code></pre></div><p>The <code>order=2</code> takes care of telling <code>telegraf</code> to convert the <code>field</code> called <code>result</code> to a <code>tag</code> only after the <code>enum</code> mappings occur.</p></li></ol><h2 id=complete-configuration-file>Complete Configuration File</h2><script type=application/javascript src=https://gist.github.com/shantanoo-desai/5399f98476d0cacc0746a6fa75ef1a1b.js></script><h3 id=deployment-via-docker>Deployment via Docker</h3><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># assuming the above config file is in a directory called `telegraf`</span>
docker run  -d --name<span class=o>=</span>telegraf-converter -v <span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span>/telegraf/telegraf.convert.toml:/etc/telegraf/telegraf.conf:ro telegraf:latest
</code></pre></div><p>See the logs using:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>docker logs -f telegraf-converter
</code></pre></div><h2 id=conclusions>Conclusions</h2><blockquote><p>Why write scripts for things when you can write a TOML configuration in <code>telegraf</code>!!
&ndash;<div id=id-1><em>Lazy-ius Maximus</em></div></p></blockquote><p>If you have more thoughts, improvements and criticisms then connect with me or send me an E-mail or a <strong>LinkedIn Message</strong> anytime!</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 03-09-2020</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://shantanoo-desai.github.io/posts/technology/nugget_tags_fields_mgmt_with_telegraf_influxdb/ data-title="Nugget: Let Telegraf manage your InfluxDB Fields and Tags for you" data-hashtags=MQTT,IoT,Telegraf,InfluxDB><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://shantanoo-desai.github.io/posts/technology/nugget_tags_fields_mgmt_with_telegraf_influxdb/ data-hashtag=MQTT><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://shantanoo-desai.github.io/posts/technology/nugget_tags_fields_mgmt_with_telegraf_influxdb/><i class="fab fa-linkedin fa-fw"></i></a><a href=javascript:void(0); title="Share on WhatsApp" data-sharer=whatsapp data-url=https://shantanoo-desai.github.io/posts/technology/nugget_tags_fields_mgmt_with_telegraf_influxdb/ data-title="Nugget: Let Telegraf manage your InfluxDB Fields and Tags for you" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://shantanoo-desai.github.io/posts/technology/nugget_tags_fields_mgmt_with_telegraf_influxdb/ data-title="Nugget: Let Telegraf manage your InfluxDB Fields and Tags for you"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://shantanoo-desai.github.io/posts/technology/nugget_tags_fields_mgmt_with_telegraf_influxdb/><i class="fab fa-reddit fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/mqtt/>MQTT</a>,&nbsp;<a href=/tags/iot/>IoT</a>,&nbsp;<a href=/tags/telegraf/>Telegraf</a>,&nbsp;<a href=/tags/influxdb/>InfluxDB</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/technology/questitto_light_stack_for_iot/ class=prev rel=prev title="Questitto: Light-weight, Blazing Fast Stack for your IoT Application"><i class="fas fa-angle-left fa-fw"></i>Questitto: Light-weight, Blazing Fast Stack for your IoT Application</a>
<a href=/posts/technology/nugget_mosquitto_docker_persistence_without_sudo/ class=next rel=next title="Nugget: Enabling Persistence and Logging for your Mosquitto MQTT Broker Docker Container without Super User Privileges">Nugget: Enabling Persistence and Logging for your Mosquitto MQTT Broker Docker Container without Super User Privileges<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.70.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2021</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/css/790698.min.css><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":20},"comment":{}};</script><script type=text/javascript src=/js/theme.min.js></script></body></html>