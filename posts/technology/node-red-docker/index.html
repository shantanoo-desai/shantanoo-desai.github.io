<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Create a custom Node-Red Container with Integration Testing - Shan's Corner</title><meta name=Description content="Shan's World"><meta property="og:title" content="Create a custom Node-Red Container with Integration Testing"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:url" content="https://shantanoo-desai.github.io/posts/technology/node-red-docker/"><meta property="article:published_time" content="2022-04-10T11:27:22+02:00"><meta property="article:modified_time" content="2022-04-10T11:27:22+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Create a custom Node-Red Container with Integration Testing"><meta name=twitter:description content><meta name=application-name content="Shan's World"><meta name=apple-mobile-web-app-title content="Shan's World"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://shantanoo-desai.github.io/posts/technology/node-red-docker/><link rel=prev href=https://shantanoo-desai.github.io/posts/technology/docker-compose-offline-stack/><link rel=next href=https://shantanoo-desai.github.io/posts/technology/thoughts-as-a-repo/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Create a custom Node-Red Container with Integration Testing","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/shantanoo-desai.github.io\/posts\/technology\/node-red-docker\/"},"genre":"posts","keywords":"node-red, docker, docker-compose, integration, testing","wordcount":989,"url":"https:\/\/shantanoo-desai.github.io\/posts\/technology\/node-red-docker\/","datePublished":"2022-04-10T11:27:22+02:00","dateModified":"2022-04-10T11:27:22+02:00","publisher":{"@type":"Organization","name":"Shan"},"author":{"@type":"Person","name":"Shan"},"description":""}</script></head><body header-desktop header-mobile><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Shan's Corner">Shan's Corner</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/now title="What am I currently focusing on">Now </a><a class=menu-item href=/posts/ title="My thoughts and works digitally transcribed">Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/about/ title="Everything You wish to know about me">About </a><a class=menu-item href=/categories/>Categories </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Shan's Corner">Shan's Corner</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/now title="What am I currently focusing on">Now</a><a class=menu-item href=/posts/ title="My thoughts and works digitally transcribed">Posts</a><a class=menu-item href=/tags/>Tags</a><a class=menu-item href=/about/ title="Everything You wish to know about me">About</a><a class=menu-item href=/categories/>Categories</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Create a custom Node-Red Container with Integration Testing</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Shan</a></span>&nbsp;<span class=post-category>included in <a href=/categories/technology/><i class="far fa-folder fa-fw"></i>Technology</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=10-04-2022>10-04-2022</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;989 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;5 minutes&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#pre-requisites>Pre-Requisites</a></li><li><a href=#requirements>Requirements</a></li><li><a href=#follow-along>Follow Along</a></li><li><a href=#custom-node-red-docker-container-creation>Custom Node-Red Docker Container Creation</a><ul><li><a href=#adding-node-red-and-its-dependencies>Adding Node-Red and its Dependencies</a></li><li><a href=#multi-stage-dockerfile-for-a-slim-image>Multi-Stage Dockerfile for a Slim Image</a></li><li><a href=#add-a-healthcheck-api-in-node-red>Add a Healthcheck API in Node-Red</a></li></ul></li><li><a href=#integration-test-of-your-node-red-image>Integration Test of your Node-Red Image</a><ul><li><a href=#testing-files>Testing Files</a></li><li><a href=#additional-using-this-setup-in-a-cicd-pipeline-using-github>Additional: using this setup in a CI/CD Pipeline using GitHub</a></li></ul></li><li><a href=#inference>Inference</a></li></ul></nav></div></div><div class=content id=content><h2 id=pre-requisites>Pre-Requisites</h2><p>This post assumes that the reader has an understanding about <a href=https://nodered.org/ target=_blank rel="noopener noreffer">Node-Red</a> Flow
Programming tool and wishes to work with a custom Docker Images for it.</p><p>This post also assumes the readers are familiar with python programming.</p><h2 id=requirements>Requirements</h2><p>Since Node-Red provides a <em>visual</em> way of connecting many components through Flows,
we might be interested in using it for our own personal stack.</p><p>If you haven&rsquo;t tried it out, <a href=https://nodered.org/docs/getting-started/docker target=_blank rel="noopener noreffer">Node-Red Documentation for Docker</a> provides some nice
ways to getting started.</p><p>Since the Flows are rendered to a web-browser, we might want to take into consideration
testing our custom Node-Red container when it might be integrated with other containers
within a stack deployment.</p><p>This guide will provide a concise way of joining the dots between creating your custom
Node-Red container and testing its reachability within a <code>docker-compose</code> file using
the <a href=https://pypi.org/project/pytest-docker-compose/ target=_blank rel="noopener noreffer"><code>pytest-docker-compose</code> suite</a>.</p><h2 id=follow-along>Follow Along</h2><p>Please refer to the <a href=https://github.com/shantanoo-desai/node-red-slim target=_blank rel="noopener noreffer">GitHub Repository</a> for
the code structure and file content</p><h2 id=custom-node-red-docker-container-creation>Custom Node-Red Docker Container Creation</h2><p>Diving into the deep-end straight, we want to create a Node-Red custom container with
just the following:</p><ol><li><code>node-red</code> runtime-engine</li><li><code>node-red</code> dashboard</li></ol><blockquote><p>NOTE: for this post sake, we stick to basic things, please feel free to add more things
according to you needs.</p></blockquote><h3 id=adding-node-red-and-its-dependencies>Adding Node-Red and its Dependencies</h3><p>Standard practice with Node-Red lets the user add dedicated flows and dependencies via the
<code>npm install</code> command-line. However within the <a href=https://github.com/node-red/node-red-docker/wiki/Quick-Custom-Image target=_blank rel="noopener noreffer">Node-Red-Docker Repo Wiki</a>, you can also
add these flows/dependencies via a dedicated <code>package.json</code>.</p><p>Let&rsquo;s stick to this method and avoid adding things via CLI within the container.</p><p>Create a <code>package.json</code> file and add the following:</p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>
    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;node-red-slim-container&#34;</span><span class=p>,</span>
    <span class=nt>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;A Slim Node-RED Docker Image running on Alpine Container&#34;</span><span class=p>,</span>
    <span class=nt>&#34;dependencies&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;node-red&#34;</span><span class=p>:</span> <span class=s2>&#34;&gt;=2.2.0&#34;</span><span class=p>,</span>
        <span class=nt>&#34;node-red-dashboard&#34;</span><span class=p>:</span> <span class=s2>&#34;*&#34;</span>
    <span class=p>},</span>
    <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;node $NODE_OPTIONS node_modules/node-red/red.js $FLOWS --userDir=/data&#34;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>Moving on to creating a <code>Dockerfile</code></p><h3 id=multi-stage-dockerfile-for-a-slim-image>Multi-Stage Dockerfile for a Slim Image</h3><p>We will be using a <a href=https://docs.docker.com/develop/develop-images/multistage-build/ target=_blank rel="noopener noreffer">Multi-Stage Docker build process</a> to keep our image a bit <em>light</em> on the
size using <code>alpine</code> based containers and the official <code>minimal</code> image from Node-Red.</p><p>We will use <strong>TWO-Stages</strong> in our build process:</p><ol><li>prepare a base Image with <code>alpine</code></li><li>use <code>nodered/node-red-minimal</code> image to install the flows/deps and prepare the <code>node_modules</code></li></ol><p>We then use the base Image in step 1 as a production image and copy the <code>node_modules</code> directory
to this production image.</p><p>Our <code>Dockerfile</code> looks like the following:</p><div class=highlight><pre class=chroma><code class=language-docker data-lang=docker><span class=k>FROM</span><span class=s> alpine:3.13 AS base</span><span class=err>
</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>RUN</span> apk add --no-cache <span class=se>\
</span><span class=se></span>            nodejs <span class=se>\
</span><span class=se></span>            npm <span class=o>&amp;&amp;</span> <span class=se>\
</span><span class=se></span>    mkdir -p /usr/src/node-red /data <span class=o>&amp;&amp;</span> <span class=se>\
</span><span class=se></span>    adduser -h /usr/src/node-red -D -H node-red -u <span class=m>1000</span> <span class=o>&amp;&amp;</span> <span class=se>\
</span><span class=se></span>    chown -R node-red:node-red /data <span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>FROM</span><span class=s> nodered/node-red:2.2.2-minimal AS build</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>COPY</span> package.json .<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>RUN</span> npm install <span class=se>\
</span><span class=se></span>        --unsafe-perm --no-update-notifier <span class=se>\ </span><span class=err>
</span><span class=err></span>        --no-audit --only<span class=o>=</span>production<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>FROM</span><span class=s> base as prod</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>build --chown<span class=o>=</span>node-red:node-red /data/ /data/<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>WORKDIR</span><span class=s> /usr/src/node-red</span><span class=err>
</span><span class=err></span><span class=k>COPY</span> settings.js /data/settings.js<span class=err>
</span><span class=err></span><span class=k>COPY</span> flows.json  /data/flows.json<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>build --chown<span class=o>=</span>node-red:node-red /usr/src/node-red/  /usr/src/node-red/<span class=err>
</span><span class=err></span><span class=k>USER</span><span class=s> node-red</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;npm&#34;</span><span class=p>,</span> <span class=s2>&#34;start&#34;</span><span class=p>]</span><span class=err>
</span></code></pre></div><p>We start with the base image as <code>alpine:3.13</code> and prepare it by adding <code>nodejs</code> and <code>npm</code>
needing to run Node-Red. For security best-practices, we add a <code>node-red</code> user and group as
opposed to running everything as <code>root</code>. This avoids any privilege escalation within the container,
as well as misuse within the container.</p><p>Our <code>build</code> stage will install all the NPM packages in our <code>package.json</code> and then we copy the
necessary <code>node_modules</code> to our <code>prod</code> image. In the end, we will run the command as <code>npm start</code></p><p>You can build this image locally using:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>docker build -t node-red-slim:latest .
</code></pre></div><h3 id=add-a-healthcheck-api-in-node-red>Add a Healthcheck API in Node-Red</h3><p>You can refer to this <a href=https://discourse.nodered.org/t/is-there-an-http-api-where-i-can-ask-for-pings-for-integration-tests/59707 target=_blank rel="noopener noreffer">Discussion Thread on Node-Red Forum</a> to create the flow, or use the following
<a href=https://github.com/shantanoo-desai/node-red-slim/blob/main/flows.json target=_blank rel="noopener noreffer"><code>flows.json</code></a> file</p><p>We can check if the flow is working again but building the Docker Image and then try:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>    curl -XGET http://localhost:1880/health
</code></pre></div><p>Don&rsquo;t forget to set the port 1880 when running the docker image e.g.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>    docker run -p 1880:1880 node-red-slim:latest
</code></pre></div><p>If that works, good job! now it is time to make an integration test with python</p><h2 id=integration-test-of-your-node-red-image>Integration Test of your Node-Red Image</h2><p>One cool thing you can try out is the <a href=https://pypi.org/project/pytest-docker-compose/ target=_blank rel="noopener noreffer">pytest-docker-compose</a> which provides you a nice suite
to do tests with <code>docker-compose</code>. I won&rsquo;t dive too deep into it, but I relied on this
<a href=https://dev.to/xnuinside/integration-tests-for-bunch-of-services-with-pytest-docker-compose-j5i target=_blank rel="noopener noreffer">Dev.To post by Iuliia Volkova</a> for wrting a simple test that does a health check on our
<code>/health</code> API once the container is up and running.</p><h3 id=testing-files>Testing Files</h3><p><code>pytest-docker-compose</code> is a plugin for <code>pytest</code> testing suite. The structure of your test directory
should be as follows:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>.
├── README.md
├── requirements.dev.txt
├── scripts
│   ├── 00-build-test-env.sh
│   └── 01-run-tests.sh
├── test-docker-compose.yml
└── tests
    ├── conftest.py
    └── test_fixtures.py
</code></pre></div><p>Refer to <a href=https://github.com/shantanoo-desai/node-red-slim/tree/main/tests/integration target=_blank rel="noopener noreffer">tests/integration</a> directory for file contents</p><p>The <code>conftest.py</code> is used to as fixture for the <code>test-docker-compose.yml</code> to be used for the test stack.</p><p>the <code>test_fixture.py</code> contains the test fixture to ping the <code>/health</code> API from our flow once the
node-red container</p><p>For our case, if the <code>/health</code> API provides a HTTP 200 OK response, our test passes. You can add more
tests depending on your requirements.</p><p>We will leverage simple bash scripts in the <code>scripts</code> directory to setup the python
virtualenvironment as to bring the <code>test-docker-compose</code> up and run the pytest</p><h3 id=additional-using-this-setup-in-a-cicd-pipeline-using-github>Additional: using this setup in a CI/CD Pipeline using GitHub</h3><p>You can think of our steps we just went through as a CI/CD Pipeline. The steps are:</p><ol><li>Build our custom <strong>Node-Red</strong> Docker Image</li><li>Test Integration using <code>pytest-docker-compose</code></li><li>Push the image to Docker Hub, if test passes</li></ol><p>For the repository, I have setup a GitHub Workflow that pushes the docker image only
when I push a Tag e.g. <code>v1.2.0</code> etc.</p><p>For this Workflow, you will need to setup the credentials of your Registry in your GitHub Secrets.
For a sample of the YAML file, refer to this <a href=https://github.com/shantanoo-desai/node-red-slim/blob/main/.github/workflows/deploy.yml target=_blank rel="noopener noreffer">deploy.yml</a></p><h2 id=inference>Inference</h2><p>That&rsquo;s how you do custom node-red, docker, docker-compose and integration testing !</p><p>I am not aware of conducting tests of the individual tests of the flows generated in Node-Red, but this
test focuses on integrating node-red with some possible stacks where different Databases are part of the
stack.</p><p>If you have comments, criticisms, feedback please reach out to me and I will be happy to learn and help!</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 10-04-2022</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://shantanoo-desai.github.io/posts/technology/node-red-docker/ data-title="Create a custom Node-Red Container with Integration Testing" data-hashtags=node-red,docker,docker-compose,integration,testing><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://shantanoo-desai.github.io/posts/technology/node-red-docker/ data-hashtag=node-red><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://shantanoo-desai.github.io/posts/technology/node-red-docker/><i class="fab fa-linkedin fa-fw"></i></a><a href=javascript:void(0); title="Share on WhatsApp" data-sharer=whatsapp data-url=https://shantanoo-desai.github.io/posts/technology/node-red-docker/ data-title="Create a custom Node-Red Container with Integration Testing" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://shantanoo-desai.github.io/posts/technology/node-red-docker/ data-title="Create a custom Node-Red Container with Integration Testing"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://shantanoo-desai.github.io/posts/technology/node-red-docker/><i class="fab fa-reddit fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/node-red/>node-RED</a>,&nbsp;<a href=/tags/docker/>docker</a>,&nbsp;<a href=/tags/docker-compose/>docker-compose</a>,&nbsp;<a href=/tags/integration/>integration</a>,&nbsp;<a href=/tags/testing/>testing</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/technology/docker-compose-offline-stack/ class=prev rel=prev title="Nugget: Prepare your Docker-Compose Stack as a Tarball for Offline Installations"><i class="fas fa-angle-left fa-fw"></i>Nugget: Prepare your Docker-Compose Stack as a Tarball for Offline Installations</a>
<a href=/posts/technology/thoughts-as-a-repo/ class=next rel=next title="Thoughts-as-a-Repository: Thoughts as a Git Repo">Thoughts-as-a-Repository: Thoughts as a Git Repo<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.70.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{}};</script><script type=text/javascript src=/js/theme.min.js></script></body></html>