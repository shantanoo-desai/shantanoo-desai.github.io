<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Forward Compatibility for Mosquitto MQTT Broker with Docker Compose v2 - Shan's Corner</title><meta name=Description content="Shan's World"><meta property="og:title" content="Forward Compatibility for Mosquitto MQTT Broker with Docker Compose v2"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:url" content="https://shantanoo-desai.github.io/posts/technology/mosquitto-fwd-compatibility-docker/"><meta property="article:published_time" content="2023-10-23T21:45:00+02:00"><meta property="article:modified_time" content="2023-10-23T21:45:00+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Forward Compatibility for Mosquitto MQTT Broker with Docker Compose v2"><meta name=twitter:description content><meta name=application-name content="Shan's World"><meta name=apple-mobile-web-app-title content="Shan's World"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://shantanoo-desai.github.io/posts/technology/mosquitto-fwd-compatibility-docker/><link rel=prev href=https://shantanoo-desai.github.io/posts/technology/mosquitto_ansible_passgen/><link rel=next href=https://shantanoo-desai.github.io/posts/technology/ansible_collection_patch/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Forward Compatibility for Mosquitto MQTT Broker with Docker Compose v2","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/shantanoo-desai.github.io\/posts\/technology\/mosquitto-fwd-compatibility-docker\/"},"genre":"posts","keywords":"devops, mqtt, iot, docker","wordcount":685,"url":"https:\/\/shantanoo-desai.github.io\/posts\/technology\/mosquitto-fwd-compatibility-docker\/","datePublished":"2023-10-23T21:45:00+02:00","dateModified":"2023-10-23T21:45:00+02:00","publisher":{"@type":"Organization","name":"Shan"},"author":{"@type":"Person","name":"Shan"},"description":""}</script></head><body header-desktop header-mobile><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Shan's Corner">Shan's Corner</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/now title="What am I currently focusing on">Now </a><a class=menu-item href=/posts/ title="My thoughts and works digitally transcribed">Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/about/ title="Everything You wish to know about me">About </a><a class=menu-item href=/categories/>Categories </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Shan's Corner">Shan's Corner</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/now title="What am I currently focusing on">Now</a><a class=menu-item href=/posts/ title="My thoughts and works digitally transcribed">Posts</a><a class=menu-item href=/tags/>Tags</a><a class=menu-item href=/about/ title="Everything You wish to know about me">About</a><a class=menu-item href=/categories/>Categories</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Forward Compatibility for Mosquitto MQTT Broker with Docker Compose v2</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Shan</a></span>&nbsp;<span class=post-category>included in <a href=/categories/technology/><i class="far fa-folder fa-fw"></i>Technology</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=23-10-2023>23-10-2023</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;685 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;4 minutes&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#observations>Observations</a><ul><li><a href=#current-docker-compose-file>Current Docker Compose File</a></li><li><a href=#caveats>Caveats</a></li></ul></li><li><a href=#solution>Solution</a></li><li><a href=#github-gist>GitHub Gist</a></li></ul></nav></div></div><div class=content id=content><h1 id=planning>Planning</h1><p>While working on a personal project <a href=https://github.com/shantanoo-desai/komponist target=_blank rel="noopener noreffer">Komponist</a>, it was due to update
<a href=https://github.com/eclipse/mosquitto target=_blank rel="noopener noreffer">Mosquitto MQTT Broker</a> due to a <a href=https://github.com/eclipse/mosquitto/blob/v2.0.18/ChangeLog.txt#L27 target=_blank rel="noopener noreffer">CVE</a> and found some interesting changes
that will impact me in the future when it comes to configuring the Broker. This post
provides a solution to make the Broker compatible with future versions using new and
less visited concepts in <strong>Docker Compose v2</strong>, namely:</p><ul><li>Docker Init Containers</li><li>Using the <code>include</code> feature in Docker Compose files</li></ul><h2 id=observations>Observations</h2><p>This section provides information on what currently is observed post upgrading the
Mosquitto Broker to <strong>v2.0.18</strong>.</p><h3 id=current-docker-compose-file>Current Docker Compose File</h3><p>This is my current <code>docker-compose.mosquitto.yml</code> with the following file structure
generated by <strong>Komponist</strong>:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=p>|</span>- docker-compose.mosquitto.yml
<span class=p>|</span>-- mosquitto
    <span class=p>|</span>--- acl
    <span class=p>|</span>--- users
    <span class=p>|</span>--- mosquitto.conf
</code></pre></div><p>The Compose file content is:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>services</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>mosquitto</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=k>image</span><span class=p>:</span><span class=w> </span>docker.io/eclipse-mosquitto<span class=p>:</span><span class=m>2.0.18</span><span class=w>
</span><span class=w>    </span><span class=k>container_name</span><span class=p>:</span><span class=w> </span>komponist_mosquitto<span class=w>
</span><span class=w>    </span><span class=k>configs</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- mosquitto_conf<span class=w>
</span><span class=w>      </span>- mosquitto_acl<span class=w>
</span><span class=w>      </span>- mosquitto_users<span class=w>
</span><span class=w>    </span><span class=k>command</span><span class=p>:</span><span class=w> </span>mosquitto<span class=w> </span>-c<span class=w> </span>/mosquitto_conf<span class=w>
</span><span class=w>    </span><span class=k>security_opt</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=s2>&#34;no-new-privileges=true&#34;</span><span class=w>
</span><span class=w>    </span><span class=k>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- /etc/timezone<span class=p>:</span>/etc/timezone<span class=p>:</span>ro<span class=w>
</span><span class=w>      </span>- /etc/localtime<span class=p>:</span>/etc/localtime<span class=p>:</span>ro<span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>configs</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>mosquitto_conf</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=k>file</span><span class=p>:</span><span class=w> </span>./mosquitto/mosquitto.conf<span class=w>
</span><span class=w>  </span><span class=k>mosquitto_acl</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=k>file</span><span class=p>:</span><span class=w> </span>./mosquitto/acl<span class=w>
</span><span class=w>  </span><span class=k>mosquitto_users</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=k>file</span><span class=p>:</span><span class=w> </span>./mosquitto/users<span class=w>
</span></code></pre></div><p>Bringing the container up using:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>docker compose -f docker-compose.mosquitto.yml up
</code></pre></div><p>The logs will throw some warnings such as the following:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>Warning: File /mosquitto_users has world readable permissions. Future versions will refuse to load this file.

Warning: File /mosquitto_users owner is not mosquitto. Future versions will refuse to load this file.
...
...

</code></pre></div><p>So for future versions the files need to have a specific user and file permissions
to make the current configuration files valid.</p><h3 id=caveats>Caveats</h3><p>In systems where I do not have superuser privileges to create a new user <code>mosquitto</code> whose
UID/GID should be <code>1883</code> and changing file permissions is not an option, the only way to tackle
such a solution is through Docker Init Containers.</p><p>Docker Init Containers are like sidecar containers in Kubernetes or a patching container where
it initializes a state (here specific configuration file) and then starts the core container.</p><p>This feature has existed for a while, but it is not well documented in the Compose Specifications
with some practical examples. In essence, we will use the <code>depends_on</code> service dependency logic
between a generic <code>alpine</code> container that will:</p><ol><li>change the user for the core configuration files</li><li>change the file permissions for the core configuration files</li><li>pass on the core files to the <code>eclipse-mosquitto</code> broker using shared volumes</li></ol><p>Once this container is mounted with the files and is run successfully, the adapted configuration
files will be passed on to the main docker container for the Mosquitto MQTT Broker.</p><h2 id=solution>Solution</h2><p>We keep the file structure same as previously mentioned but we create a new Compose file
called <code>docker-compose.mosquitto-init.yml</code> file as follows:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>services</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>mosquitto_init</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=k>image</span><span class=p>:</span><span class=w> </span>alpine<span class=p>:</span><span class=m>3.18</span><span class=w>
</span><span class=w>    </span><span class=k>container_name</span><span class=p>:</span><span class=w> </span>mosquitto_init<span class=w>
</span><span class=w>    </span><span class=k>command</span><span class=p>:</span><span class=w> </span>sh<span class=w> </span>-c<span class=w> </span><span class=s1>&#39;chmod 0400 -R /config/ &amp;&amp; chown 1883:1883 -R /config/&#39;</span><span class=w>
</span><span class=w>    </span><span class=k>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- ./mosquitto/mosquitto.conf<span class=p>:</span>/config/mosquitto_conf<span class=w>
</span><span class=w>      </span>- ./mosquitto/users<span class=p>:</span>/config/mosquitto_users<span class=w>
</span><span class=w>      </span>- ./mosquitto/acl<span class=p>:</span>/config/mosquitto_acl<span class=w>
</span></code></pre></div><p>We are mounting the configuration files into the init container under the <code>/config</code> directory
and changing the file persmissions and ownership for the files in this init container.</p><blockquote><p>NOTE: we will have to refactor out the Docker Configs section previously configured in
original <code>docker-compose.mosquitto.yml</code> file into the <code>docker-compose.mosquitto-init.yml</code> file</p></blockquote><p>We now refactor the <code>mosquitto.conf</code> file a bit to accept the new location for the files
as follows:</p><pre><code># MQTT Port Listener
listener    1883
protocol    mqtt

# Authentication
allow_anonymous     false
password_file       /config/mosquitto_users

# Authorization
acl_file    /config/mosquitto_acl
# Logging Configuration
log_timestamp true
log_type all
</code></pre><p>Note the <code>/config</code> as prefix to the ACL and password file.</p><p>Final refactoring takes place in the <code>docker-compose.mosquitto.yml</code> file as follows:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>include</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- docker-compose.mosquitto-init.yml<span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>services</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>mosquitto</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=k>image</span><span class=p>:</span><span class=w> </span>docker.io/eclipse-mosquitto<span class=p>:</span><span class=m>2.0.18</span><span class=w>
</span><span class=w>    </span><span class=k>container_name</span><span class=p>:</span><span class=w> </span>komponist_mosquitto<span class=w>
</span><span class=w>    </span><span class=k>entrypoint</span><span class=p>:</span><span class=w> </span>mosquitto<span class=w> </span>-c<span class=w> </span>/config/mosquitto_conf<span class=w>
</span><span class=w>    </span><span class=k>depends_on</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>mosquitto_init</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=k>condition</span><span class=p>:</span><span class=w> </span>service_completed_successfully<span class=w>
</span><span class=w>    </span><span class=k>security_opt</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=s2>&#34;no-new-privileges=true&#34;</span><span class=w>
</span><span class=w>    </span><span class=k>volumes_from</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- mosquitto_init<span class=w>
</span><span class=w>    </span><span class=k>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- /etc/timezone<span class=p>:</span>/etc/timezone<span class=p>:</span>ro<span class=w>
</span><span class=w>      </span>- /etc/localtime<span class=p>:</span>/etc/localtime<span class=p>:</span>ro<span class=w>
</span><span class=w>
</span></code></pre></div><p>Upon bringing the stack up again:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>docker compose -f docker-compose.mosquitto.yml up
</code></pre></div><p>the Warnings should be gone and your config files that were valid prior to
version 2.0.18 will still be compatible for the upcoming versions (unless the development
of mosquitto demands something more in the future).</p><p>In a Nutshell, the main <code>mosquitto</code> service is now dependent on the <code>mosquitto-init</code> service
via the <code>depends_on</code> spec and core files are exchanged from the init container to the main container
via <code>volumes_from</code> spec.</p><blockquote><p>NOTE: this approach will change the file permissions / owner for the core configuration files
on the host machine since they are volume mounted.</p></blockquote><p>At the time of writing this post, this is the only approach I have tested out.</p><p>If you have read this post and have better approaches in mind, connect with me on LinkedIn and share
your solutions or improve upon the method. I would love to hear your feedback.</p><h2 id=github-gist>GitHub Gist</h2><p>the Gist of the code can be found <a href=https://gist.github.com/shantanoo-desai/1634f3206ce486707a4c047bcc043c4c target=_blank rel="noopener noreffer">here</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 23-10-2023</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://shantanoo-desai.github.io/posts/technology/mosquitto-fwd-compatibility-docker/ data-title="Forward Compatibility for Mosquitto MQTT Broker with Docker Compose v2" data-hashtags=devops,mqtt,iot,docker><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://shantanoo-desai.github.io/posts/technology/mosquitto-fwd-compatibility-docker/ data-hashtag=devops><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://shantanoo-desai.github.io/posts/technology/mosquitto-fwd-compatibility-docker/><i class="fab fa-linkedin fa-fw"></i></a><a href=javascript:void(0); title="Share on WhatsApp" data-sharer=whatsapp data-url=https://shantanoo-desai.github.io/posts/technology/mosquitto-fwd-compatibility-docker/ data-title="Forward Compatibility for Mosquitto MQTT Broker with Docker Compose v2" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://shantanoo-desai.github.io/posts/technology/mosquitto-fwd-compatibility-docker/ data-title="Forward Compatibility for Mosquitto MQTT Broker with Docker Compose v2"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://shantanoo-desai.github.io/posts/technology/mosquitto-fwd-compatibility-docker/><i class="fab fa-reddit fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/devops/>devops</a>,&nbsp;<a href=/tags/mqtt/>MQTT</a>,&nbsp;<a href=/tags/iot/>IoT</a>,&nbsp;<a href=/tags/docker/>docker</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/technology/mosquitto_ansible_passgen/ class=prev rel=prev title="Generating Mosquitto MQTT Broker Credentials with Ansible"><i class="fas fa-angle-left fa-fw"></i>Generating Mosquitto MQTT Broker Credentials with Ansible</a>
<a href=/posts/technology/ansible_collection_patch/ class=next rel=next title="Deep Dive with Ansible: Patching an Ansible Collection">Deep Dive with Ansible: Patching an Ansible Collection<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.70.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{}};</script><script type=text/javascript src=/js/theme.min.js></script></body></html>