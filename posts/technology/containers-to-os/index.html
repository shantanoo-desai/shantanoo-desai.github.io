<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Build a Bootable OS with Docker Containers using Hashicorp Packer - Shan's Corner</title><meta name=Description content="Shan's World"><meta property="og:title" content="Build a Bootable OS with Docker Containers using Hashicorp Packer"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:url" content="https://shantanoo-desai.github.io/posts/technology/containers-to-os/"><meta property="article:published_time" content="2022-09-18T12:59:53+02:00"><meta property="article:modified_time" content="2022-09-18T12:59:53+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Build a Bootable OS with Docker Containers using Hashicorp Packer"><meta name=twitter:description content><meta name=application-name content="Shan's World"><meta name=apple-mobile-web-app-title content="Shan's World"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://shantanoo-desai.github.io/posts/technology/containers-to-os/><link rel=prev href=https://shantanoo-desai.github.io/posts/technology/packer-ubuntu-qemu/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Build a Bootable OS with Docker Containers using Hashicorp Packer","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/shantanoo-desai.github.io\/posts\/technology\/containers-to-os\/"},"genre":"posts","keywords":"DevOps, IaC, Packer, Docker","wordcount":752,"url":"https:\/\/shantanoo-desai.github.io\/posts\/technology\/containers-to-os\/","datePublished":"2022-09-18T12:59:53+02:00","dateModified":"2022-09-18T12:59:53+02:00","publisher":{"@type":"Organization","name":"Shan"},"author":{"@type":"Person","name":"Shan"},"description":""}</script></head><body header-desktop header-mobile><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Shan's Corner">Shan's Corner</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/now title="What am I currently focusing on">Now </a><a class=menu-item href=/posts/ title="My thoughts and works digitally transcribed">Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/about/ title="Everything You wish to know about me">About </a><a class=menu-item href=/categories/>Categories </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Shan's Corner">Shan's Corner</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/now title="What am I currently focusing on">Now</a><a class=menu-item href=/posts/ title="My thoughts and works digitally transcribed">Posts</a><a class=menu-item href=/tags/>Tags</a><a class=menu-item href=/about/ title="Everything You wish to know about me">About</a><a class=menu-item href=/categories/>Categories</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Build a Bootable OS with Docker Containers using Hashicorp Packer</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Shan</a></span>&nbsp;<span class=post-category>included in <a href=/categories/technology/><i class="far fa-folder fa-fw"></i>Technology</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=18-09-2022>18-09-2022</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;752 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;4 minutes&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#why-do-this>Why do this?</a><ul><li><a href=#what-else-is-there-in-the-market>What else is there in the market?</a></li></ul></li><li><a href=#presenting-pockeriso>Presenting: PockerISO</a><ul><li><a href=#how-does-pockeriso-work>How does PockerISO work?</a></li><li><a href=#filesystem-generation>Filesystem Generation</a></li></ul></li><li><a href=#what-base-images-does-pockeriso-offer>What base images does PockerISO offer?</a></li><li><a href=#potential-updates>Potential Updates</a></li></ul></nav></div></div><div class=content id=content><h2 id=why-do-this>Why do this?</h2><p>I was mightly impressed by <a href=https://iximiuz.com/en/posts/from-docker-container-to-bootable-linux-disk-image/ target=_blank rel="noopener noreffer">Ivan Velichko&rsquo;s Blogpost</a> on using Docker Containers
to create bootable Disk images. He even has a <a href=https://github.com/iximiuz/docker-to-linux target=_blank rel="noopener noreffer">GitHub Repository</a> that still gets a lot of
attention from developers who have tried and tested things out.</p><p>I am already using <a href=https://packer.io target=_blank rel="noopener noreffer">Hashicorp Packer</a> at work and for personal projects and I wanted to test
this idea out by wrapping it a single Packer Template file. This reduces the level of maintaining
a lot of small scripts, Dockerfiles and configurations and the user can simply trigger a couple of
commands to get a minimalist OS at the end of the process.</p><p>Also just sheer curiousity from side. Why not try things out!</p><h3 id=what-else-is-there-in-the-market>What else is there in the market?</h3><p>Don&rsquo;t get me wrong there are some projects already out there doing things similarly, and a lot of products
leverage these tools to ship out custom, minimalist OS images for Edge Computing Devices / Cloud Platforms.</p><ul><li><a href=https://www.lfedge.org/projects/eve/ target=_blank rel="noopener noreffer">LF-Edge EVE project</a> leverages <a href=https://github.com/linuxkit/linuxkit target=_blank rel="noopener noreffer">Linuxkit</a> to create custom OSs for Edge Devices which in turn leverages
Containers as Lego Blocks</li></ul><p>Albeit these projects do much more than just create a Lego Tower of Docker Containers to create a bootable image,
but if it peeks your curiosity you should check them out.</p><h2 id=presenting-pockeriso>Presenting: PockerISO</h2><p><a href=https://github.com/shantanoo-desai/PockerISO target=_blank rel="noopener noreffer">PockerISO</a> is just Packer + Docker to create bootable images. The difference here is that Packer does the
heavy-lifting of doing the following things:</p><ul><li>pulling the base images</li><li>bringing them up</li><li>executing the respective shell scripts within the container</li><li>saving/exporting the current filesystem state into a tarball</li><li>creating an isolated container to execute the steps to create the bootable image without disturbing the host machine fs</li></ul><blockquote><p>Packer is the Maestro and Docker is the Orchestra that plays the symphony, and at the end the end-user cheers with
a nice minimalist OS image</p></blockquote><h3 id=how-does-pockeriso-work>How does PockerISO work?</h3><h3 id=filesystem-generation>Filesystem Generation</h3><p>I strongly recommend reading Ivan Velichko&rsquo;s blogpost mentioned previously to get some greate understanding on what needs
to be done. He does some insanely cool visualizations too!</p><p>In a nutshell, containers <strong>DO NOT</strong> have a kernel (they leverage the kernel of the host machine), and they <strong>DO NOT</strong> have
system manager, containers always run with Process ID 1.</p><p>So in order to make an operating system, we will install these two things in the container base image to atleast create a
filesystem tarball which we can use to create an image.</p><p>Once the container installs the kernel, generates the respective <code>initramfs</code> for us and installs <code>systemd</code> via APTITUDE
package manager, we tell Packer to finish of this process by creating a tarball of the container&rsquo;s filesystem.</p><h4 id=bootable-image-creation>Bootable Image creation</h4><p>Once the tarball is created, we extract it on the host for the simple reason that extracting the tarball within a docker
container generally leads to a lot of Failures when done through via Packer.</p><p>We then spin up a container of the same base image copy the necessary files and folders into it. The main thing to note here
is this container is brought up with <code>privileged</code> mode. Remember we will still need the host device to use Operating System
Loop devices, to mount filesystems and create the final base image.</p><p>Within this phase we do the following via a dedicated shell script:</p><ol><li>Create an empty image file using <code>dd</code> of approximately 1GB</li><li>Make Partitions for the disk image</li><li>Create a filesystem on the image with <code>ext4</code> format</li><li>Copy our filesystem with the kernel, systemd and initramfs</li><li>Install a bootloader and create a boot partition on the image</li><li>Mount / Unmount the dedicated image</li></ol><p>The final result will be an <code>.img</code> as well as <code>.qcow2</code> image that can be tinkered with using QEMU.</p><p>As a use you only need to execute a simple <code>make</code> command:</p><pre><code>make ubuntu # or `make debian`
</code></pre><p>and at the end of the magical automation rainbow you will have a minimalist OS you can play with.</p><h2 id=what-base-images-does-pockeriso-offer>What base images does PockerISO offer?</h2><p>At this point the following:</p><ul><li><strong>Ubuntu</strong>: 20.04, 22.04</li><li><strong>Debian</strong>: <strong>bullseye</strong>, <strong>bookworm</strong></li></ul><h2 id=potential-updates>Potential Updates</h2><ul><li>I am planning to add Alpine Images with it&rsquo;s own Packer Template</li><li>I wish to make this repository compatible also for <code>linux/arm64</code> images since Docker lets you cross-compile images via BuildKit.
The only caveat is that for devices like the Raspberry Pi, the bootloader logic might be a tad bit tedious to figure out.</li></ul><p>If you would like to give some feedback, criticisms, suggestions on improving the project or this write-up leave me a message on
LinkedIn and I will happily revert back.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 18-09-2022</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://shantanoo-desai.github.io/posts/technology/containers-to-os/ data-title="Build a Bootable OS with Docker Containers using Hashicorp Packer" data-hashtags=DevOps,IaC,Packer,Docker><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://shantanoo-desai.github.io/posts/technology/containers-to-os/ data-hashtag=DevOps><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://shantanoo-desai.github.io/posts/technology/containers-to-os/><i class="fab fa-linkedin fa-fw"></i></a><a href=javascript:void(0); title="Share on WhatsApp" data-sharer=whatsapp data-url=https://shantanoo-desai.github.io/posts/technology/containers-to-os/ data-title="Build a Bootable OS with Docker Containers using Hashicorp Packer" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://shantanoo-desai.github.io/posts/technology/containers-to-os/ data-title="Build a Bootable OS with Docker Containers using Hashicorp Packer"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://shantanoo-desai.github.io/posts/technology/containers-to-os/><i class="fab fa-reddit fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/devops/>DevOps</a>,&nbsp;<a href=/tags/iac/>IaC</a>,&nbsp;<a href=/tags/packer/>Packer</a>,&nbsp;<a href=/tags/docker/>docker</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/technology/packer-ubuntu-qemu/ class=prev rel=prev title="Customized Ubuntu Images using Packer + QEMU + Cloud-Init & UEFI bootloading"><i class="fas fa-angle-left fa-fw"></i>Customized Ubuntu Images using Packer + QEMU + Cloud-Init & UEFI bootloading</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.70.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{}};</script><script type=text/javascript src=/js/theme.min.js></script></body></html>