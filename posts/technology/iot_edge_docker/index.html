<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Creating your IoT Node and Edge prototype with InfluxDB, Telegraf and Docker - Shan's Corner</title><meta name=Description content="step-by-step straight up guide to building an IoT data acquisition application with off-the-shelf hardware and InfluxData’s InfluxDB 1.7 and Telegraf"><meta property="og:title" content="Creating your IoT Node and Edge prototype with InfluxDB, Telegraf and Docker"><meta property="og:description" content="step-by-step straight up guide to building an IoT data acquisition application with off-the-shelf hardware and InfluxData’s InfluxDB 1.7 and Telegraf"><meta property="og:type" content="article"><meta property="og:url" content="https://shantanoo-desai.github.io/posts/technology/iot_edge_docker/"><meta property="article:published_time" content="2020-03-24T18:00:00+02:00"><meta property="article:modified_time" content="2020-03-24T18:00:00+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Creating your IoT Node and Edge prototype with InfluxDB, Telegraf and Docker"><meta name=twitter:description content="step-by-step straight up guide to building an IoT data acquisition application with off-the-shelf hardware and InfluxData’s InfluxDB 1.7 and Telegraf"><meta name=application-name content="Shan's World"><meta name=apple-mobile-web-app-title content="Shan's World"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://shantanoo-desai.github.io/posts/technology/iot_edge_docker/><link rel=next href=https://shantanoo-desai.github.io/posts/technology/nestjs_travis_docker/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Creating your IoT Node and Edge prototype with InfluxDB, Telegraf and Docker","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/shantanoo-desai.github.io\/posts\/technology\/iot_edge_docker\/"},"genre":"posts","keywords":"InfluxDB, Telegraf, Docker, MQTT, IoT, docker-compose, ESP32, Raspberry Pi 4","wordcount":1767,"url":"https:\/\/shantanoo-desai.github.io\/posts\/technology\/iot_edge_docker\/","datePublished":"2020-03-24T18:00:00+02:00","dateModified":"2020-03-24T18:00:00+02:00","publisher":{"@type":"Organization","name":"Shan"},"author":{"@type":"Person","name":"Shan"},"description":"step-by-step straight up guide to building an IoT data acquisition application with off-the-shelf hardware and InfluxData’s InfluxDB 1.7 and Telegraf"}</script></head><body header-desktop header-mobile><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Shan's Corner">Shan's Corner</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/ title="My thoughts and works digitally transcribed">Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/about/ title="Everything You wish to know about me">About </a><a class=menu-item href=/categories/>Categories </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Shan's Corner">Shan's Corner</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title="My thoughts and works digitally transcribed">Posts</a><a class=menu-item href=/tags/>Tags</a><a class=menu-item href=/about/ title="Everything You wish to know about me">About</a><a class=menu-item href=/categories/>Categories</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Creating your IoT Node and Edge prototype with InfluxDB, Telegraf and Docker</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Shan</a></span>&nbsp;<span class=post-category>included in <a href=/categories/technology/><i class="far fa-folder fa-fw"></i>Technology</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=24-03-2020>24-03-2020</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1767 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;9 minutes&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/images/technology/iot_influxdb_docker/chronograf_dashboard_view.png data-srcset="/images/technology/iot_influxdb_docker/chronograf_dashboard_view.png, /images/technology/iot_influxdb_docker/chronograf_dashboard_view.png 1.5x, /images/technology/iot_influxdb_docker/chronograf_dashboard_view.png 2x" data-sizes=auto alt=/images/technology/iot_influxdb_docker/chronograf_dashboard_view.png title="step-by-step straight up guide to building an IoT data acquisition application with off-the-shelf hardware and InfluxData’s InfluxDB 1.7 and Telegraf"></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#scenario>Scenario</a></li><li><a href=#requirements>Requirements</a><ul><li><a href=#hardware>Hardware</a></li><li><a href=#software>Software</a></li><li><a href=#miscellaneous>Miscellaneous</a></li></ul></li><li><a href=#iot-node>IoT Node</a><ul><li><a href=#connecting-the-lm9ds0-sensor-to-the-esp32>Connecting the LM9DS0 Sensor to the ESP32</a></li><li><a href=#arduino-libraries-and-sketch>Arduino Libraries and Sketch</a></li></ul></li><li><a href=#iot-edge>IoT Edge</a><ul><li><a href=#initial-configuration-of-pi>Initial Configuration of Pi</a></li><li><a href=#setting-up-wlan-connection-for-the-pi>Setting up WLAN Connection for the Pi</a></li><li><a href=#installing-docker-on-pi>Installing Docker on Pi</a></li><li><a href=#influxdb-using-docker-on-pi>InfluxDB using Docker on Pi</a></li><li><a href=#mosquitto-mqtt-broker-on-pi>Mosquitto MQTT Broker on Pi</a></li><li><a href=#telegraf-on-pi>Telegraf on Pi</a></li></ul></li><li><a href=#bringing-it-all-together>Bringing it all Together</a></li><li><a href=#resources>Resources</a></li></ul></nav></div></div><div class=content id=content><h2 id=scenario>Scenario</h2><p>A micro-controller connected to a digital sensor (<strong>IoT Node</strong>) will publish information to an MQTT broker running on an <strong>IoT Edge Device</strong>. The Edge Device and the IoT Node are connected to each other using WLAN. The Edge Device also has a Database that collects all the IoT Node data via the MQTT Broker.</p><h2 id=requirements>Requirements</h2><h3 id=hardware>Hardware</h3><ul><li><p>ESP32 Microcontroller</p></li><li><p>LSM9DS0 9-DoF Accelerometer + Gyroscope + Magnetometer Sensor from <a href=https://learn.adafruit.com/adafruit-lsm9ds0-accelerometer-gyro-magnetometer-9-dof-breakouts/overview target=_blank rel="noopener noreffer">Adafruit</a> (Any other digital sensor of your choice will work too)</p></li><li><p>Raspberry Pi 4 Model B (Any other Raspberry Pi Model should work too)</p></li></ul><h3 id=software>Software</h3><ul><li><p><a href=https://www.raspberrypi.org/downloads/raspbian/ target=_blank rel="noopener noreffer">Raspbian Buster Lite OS</a> for Raspberry Pi</p></li><li><p>Arduino IDE 1.8 or later to program the ESP32</p></li></ul><h3 id=miscellaneous>Miscellaneous</h3><p>A WLAN router with internet connection to create a WLAN network between your IoT Node and IoT Edge Device as well as download Docker and other tools on the Pi.</p><h2 id=iot-node>IoT Node</h2><p>We will write an Arduino Sketch to program the ESP32 to do the following tasks:</p><ol><li><p>Setup the ESP32 to connect to the WLAN Router and an MQTT Broker</p></li><li><p>Initialize the LM9DS0 sensor to send data via the I2C interface</p></li><li><p>Structure the data from the sensor into <a href=https://docs.influxdata.com/influxdb/v1.7/write_protocols/line_protocol_tutorial/ target=_blank rel="noopener noreffer">Line Protocol</a> Strings without timestamps</p></li><li><p>Publish the data to their respective MQTT topics every second</p></li></ol><h3 id=connecting-the-lm9ds0-sensor-to-the-esp32>Connecting the LM9DS0 Sensor to the ESP32</h3><p>In order to use the I2C interface the following pins of the sensor should be connected to the ESP32:</p><table><thead><tr><th>LM9DS0 Pins</th><th>ESP32 Pins</th></tr></thead><tbody><tr><td><strong>3V3</strong></td><td><strong>3V3</strong></td></tr><tr><td><strong>GND</strong></td><td><strong>GND</strong></td></tr><tr><td><strong>SCL</strong></td><td><strong>GPIO22</strong></td></tr><tr><td><strong>SDA</strong></td><td><strong>GPIO21</strong></td></tr></tbody></table><p>A <a href=https://raw.githubusercontent.com/espressif/arduino-esp32/master/docs/esp32_pinmap.png target=_blank rel="noopener noreffer">pin map diagram</a> is available on the Arduino ESP32’s GitHub Repository for reference.</p><h3 id=arduino-libraries-and-sketch>Arduino Libraries and Sketch</h3><p>Sketch mentioned below is tested for Arduino IDE 1.8.9</p><p>Make sure to download the <code>arduino-esp32</code> using the Arduino IDE Boards Manager. (Installation Guide: <a href=https://github.com/espressif/arduino-esp32#installation-instructions target=_blank rel="noopener noreffer">here</a>)</p><p>For the LSM9DS0 Sensor, download the respective libraries by following the steps <a href=https://learn.adafruit.com/adafruit-lsm9ds0-accelerometer-gyro-magnetometer-9-dof-breakouts/arduino-code#download-arduino-libraries-4-6 target=_blank rel="noopener noreffer">here</a>. Make sure to Download both, the <strong>Adafruit LSM9DS0</strong> and, the <strong>Adafruit Unified Sensor</strong> libraries.</p><p>Here is the Sketch. There are certain details you will have to change according to you network settings. These changes like <code>ssid</code>, <code>password</code> of your WLAN Router, and <code>mqtt_broker_address</code> can be configured in the IDE easily.</p><script type=application/javascript src=https://gist.github.com/shantanoo-desai/a0d80dad84ddc1ebce87f9d416ce8e9f.js></script><p>Once the IoT Edge device is ready we can write the IP address of in the <code>mqtt_broker_address</code> of the Sketch, reprogram the IoT Node and the data will be published to the broker on the Edge accordingly.</p><p>The line protocol strings for each sensor measurement looks like the following:</p><pre><code>&lt;measurement_name&gt; &lt;field1&gt;=&lt;field1val&gt;,&lt;field2&gt;=&lt;field2val&gt;...
</code></pre><p>For example, the temperature measurement in Line Protocol Format looks like:</p><pre><code>temperature temp=24
</code></pre><p>Notice, we are not sending data with any tags or timestamps. We will add relevant tags on the IoT Edge device using the power of Telegraf. For timestamps, one can add code to insert epoch timestamps using an NTP Client on the ESP32. In our case, the timestamps will be added by InfluxDB.</p><blockquote><p>Our goal, like many IoT applications is to keep the payload as light as possible.</p></blockquote><h2 id=iot-edge>IoT Edge</h2><p>Time to brush that thick layer of dust off your Raspberry Pi ! For this post, we use a Raspberry Pi 4 Model B with 2GB RAM. However a Raspberry Pi 3 should work just fine.</p><h3 id=initial-configuration-of-pi>Initial Configuration of Pi</h3><p>Here are some quick steps to follow to setup the Pi:</p><ol><li>Download Raspbian Buster Lite</li><li>Flash the OS Image on to an SD Card (Use balenaEtcher for Windows)</li><li>Connect Pi to a screen and a keyboard and power it up</li></ol><h3 id=setting-up-wlan-connection-for-the-pi>Setting up WLAN Connection for the Pi</h3><p>Edit the <code>wpa_supplicant.conf</code> file by using the following in Pi’s terminal:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>sudo nano /etc/wpa_supplicant/wpa_supplicant.conf
</code></pre></div><p>Add the following settings into the file:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nv>country</span><span class=o>=</span>DE
<span class=nv>ctrl_interface</span><span class=o>=</span><span class=nv>DIR</span><span class=o>=</span>/var/run/wpa_supplicant <span class=nv>GROUP</span><span class=o>=</span>netdev
<span class=nv>update_config</span><span class=o>=</span><span class=m>1</span>
<span class=nv>network</span><span class=o>={</span>
    <span class=nv>scan_ssid</span><span class=o>=</span><span class=m>1</span>
    <span class=nv>ssid</span><span class=o>=</span><span class=s2>&#34;&lt;YOUR_WLAN_SSID&gt;&#34;</span>
    <span class=nv>psk</span><span class=o>=</span><span class=s2>&#34;&lt;YOUR_PASSWORD&gt;&#34;</span>
<span class=o>}</span>
</code></pre></div><p><code>CTRL + O</code> and then <code>CTRL+X</code> to write the content in the file.</p><p>Check if your Kernel is blocking the WLAN interface on the Pi using:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>sudo rfkill list
</code></pre></div><p>If your WLAN interface is Soft Blocked, i.e. <code>Soft blocked: yes</code> then unblock it using:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>sudo rfkill unblock wifi
</code></pre></div><p>Change the <code>/etc/network/interfaces</code> file to the following:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>auto lo
iface lo inet loopbackauto wlan0
allow-hotplug wlan0
iface wlan0 inet manual
wpa-roam /etc/wpa_supplicant/wpa_supplicant.conf
</code></pre></div><p>This configuration will make your <code>wlan0</code> interface ask your WLAN router for an IP address once the interface itself is up. Finally, do the following to wake the <code>wlan0</code> interface up:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>sudo ifdown wlan0
sudo ifup wlan0
</code></pre></div><p>This should make the Pi obtain an IP address from the router and it should be connected to the network. To check your IP address simply do:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>ifconfig wlan0
</code></pre></div><p>To check connectivity to the Internet ping Google’s DNS Server:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>ping 8.8.8.8
</code></pre></div><h3 id=installing-docker-on-pi>Installing Docker on Pi</h3><p>Instead of installing each software tool on the Pi individually, we will install and use Docker to do the heaving lifting for us and hence saving a lot of time.</p><p>To install docker on the Pi perform:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>curl -sSL https://get.docker.com <span class=p>|</span> sh
</code></pre></div><p>This should install docker Community Edition on the Pi. During the time of writing this post the version installed on the Pi was:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>docker --version
19.03.8 build afac686
</code></pre></div><p>Make sure you can run Docker on the Pi with sudo privileges but adding:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>sudo usermod -aG docker pi
</code></pre></div><p>Logout of the Pi by typing exit and login back.</p><p>To test Docker on the Pi, run:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>docker run hello-world
</code></pre></div><h3 id=influxdb-using-docker-on-pi>InfluxDB using Docker on Pi</h3><p>We will spin docker images on the Pi individually for each tool. For InfluxDB 1.7.x on the Pi:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>docker run --name piflux <span class=se>\
</span><span class=se></span>           -d
           -p 8083:8083 <span class=se>\
</span><span class=se></span>           -p 8086:8086 <span class=se>\
</span><span class=se></span>           -v influxdb:/var/lib/influxdb
           influxdb
</code></pre></div><p>This should bring up an InfluxDB 1.7.x container running in detached mode under the name <code>piflux</code> . To check if the DB is reachable use curl on the Pi:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>curl -i -XGET http://localhost:8086/ping
</code></pre></div><p>It might also be worth performing the same action with a computer connected to the same WLAN network as that of the Pi with the IP address of the Pi as follows:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>curl -i -XGET http://&lt;PI_IP_ADDRESS&gt;:8086/ping
</code></pre></div><h3 id=mosquitto-mqtt-broker-on-pi>Mosquitto MQTT Broker on Pi</h3><p>Create a directory to store the Mosquitto broker’s configuration:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>mkdir mosquitto/
mkdir mosquitto/config
touch mosquitto/config/mosquitto.conf
</code></pre></div><p>The configuration is a default one to make the broker persistent. The configuration file is as follows:</p><pre><code>persistence true
persistence_location /mosquitto/data/
log_data file /mosquitto/log/mosquitto.log
</code></pre><p>Spin up a container for Mosquitto broker as follows:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>docker run --name pibroker <span class=se>\
</span><span class=se></span>           -d
           -p 1883:1883
           -p 9001:9001
           -v <span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span>/mosquitto/config/mosquitto.conf:/mosquitto/config/mosquitto.conf
            eclipse-mosquitto
</code></pre></div><p>This should make an MQTT Broker ready on the Pi. You can now update the <code>mqtt_broker_address</code> in the Arduino Sketch above and subscribe to anyone of the topics via a GUI based MQTT client on the computer in the network so see published data on the broker.</p><h3 id=telegraf-on-pi>Telegraf on Pi</h3><p>Telegraf is the real <em>Swiss Army Knife</em> here which will do the following tasks for us:</p><ol><li>Connect to the MQTT Broker on the Pi and Insert the data into InfluxDB</li><li>Will add the <code>SENSOR_ID</code> in the MQTT topic as a <code>tag</code> into InfluxDB.</li></ol><p>Let’s create a sample config for MQTT as an input to Telegraf and InfluxDB as Output using Docker:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>docker run --rm telegraf -sample-config <span class=se>\ </span>
                -input-filter mqtt_consumer <span class=se>\
</span><span class=se></span>                -output-filter influxdb &gt; telegraf.conf
</code></pre></div><p>This should create a telegraf.conf in the working directory on the Pi.</p><p>Let’s organize a bit:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>mkdir telegraf/
mv telegraf.conf telegraf/
</code></pre></div><h4 id=telegraf-configuration>Telegraf Configuration</h4><p>The configuration file that is needed is as follows:</p><div class=highlight><pre class=chroma><code class=language-toml data-lang=toml><span class=p>[</span><span class=nx>agent</span><span class=p>]</span>
 <span class=nx>interval</span> <span class=p>=</span> <span class=s2>&#34;10s&#34;</span>
 <span class=nx>round_interval</span> <span class=p>=</span> <span class=kc>true</span>
 <span class=nx>metric_batch_size</span> <span class=p>=</span> <span class=mi>1000</span>
 <span class=nx>metric_buffer_limit</span> <span class=p>=</span> <span class=mi>10000</span>
 <span class=nx>collection_jitter</span> <span class=p>=</span> <span class=s2>&#34;0s&#34;</span>
 <span class=nx>flush_interval</span> <span class=p>=</span> <span class=s2>&#34;10s&#34;</span>
 <span class=nx>flush_jitter</span> <span class=p>=</span> <span class=s2>&#34;0s&#34;</span>
 <span class=nx>precision</span> <span class=p>=</span> <span class=s2>&#34;&#34;</span>
 <span class=nx>quiet</span> <span class=p>=</span> <span class=kc>false</span>
 <span class=nx>hostname</span> <span class=p>=</span> <span class=s2>&#34;&#34;</span>
 <span class=nx>omit_hostname</span> <span class=p>=</span> <span class=kc>false</span>
 
 <span class=p>[[</span><span class=nx>outputs</span><span class=p>.</span><span class=nx>influxdb</span><span class=p>]]</span>
<span class=c># Configuration for InfluxDB urls = [&#34;http://127.0.0.1:8086&#34;]</span>
 <span class=nx>database</span> <span class=p>=</span> <span class=s2>&#34;edge&#34;</span> <span class=c># Name it whatever you like</span>
 <span class=nx>skip_database_creation</span> <span class=p>=</span> <span class=kc>false</span><span class=p>[[</span><span class=nx>processors</span><span class=p>.</span><span class=nx>regex</span><span class=p>]]</span>
<span class=p>[[</span><span class=nx>processors</span><span class=p>.</span><span class=nx>regex</span><span class=p>.</span><span class=nx>tags</span><span class=p>]]</span>
<span class=c># The Magic Section key = &#34;topic&#34;</span>
 <span class=nx>pattern</span> <span class=p>=</span> <span class=s2>&#34;.*/(.*)/.*&#34;</span>
 <span class=nx>replacement</span> <span class=p>=</span> <span class=s2>&#34;${1}&#34;</span>
 <span class=nx>result_key</span> <span class=p>=</span> <span class=s2>&#34;sensorID&#34;</span>
 
 <span class=p>[[</span><span class=nx>inputs</span><span class=p>.</span><span class=nx>mqtt_consumer</span><span class=p>]]</span>
<span class=c># Configuration for MQTT Broker  servers = [&#34;tcp://127.0.0.1:1883&#34;]</span>
  <span class=nx>topics</span> <span class=p>=</span> <span class=p>[</span>
    <span class=s2>&#34;IOT/+/acc&#34;</span><span class=p>,</span>
    <span class=s2>&#34;IOT/+/mag&#34;</span><span class=p>,</span>
    <span class=s2>&#34;IOT/+/gyro&#34;</span><span class=p>,</span>
    <span class=s2>&#34;IOT/+/temp&#34;</span>
  <span class=p>]</span>
  <span class=nx>topic_tag</span> <span class=p>=</span> <span class=s2>&#34;topic&#34;</span>
  <span class=nx>qos</span> <span class=p>=</span> <span class=mi>0</span>
  <span class=nx>client_id</span> <span class=p>=</span> <span class=s2>&#34;telegraf_client&#34;</span>
  <span class=nx>data_format</span> <span class=p>=</span> <span class=s2>&#34;influx&#34;</span>
</code></pre></div><p>We can skip the <code>[agent]</code> part of the configuration and keep it the same as the default values.</p><p>The <code>[[outputs.influxdb]]</code> will tell Telegraf which InfluxDB it needs to insert the incoming data into, and under what database name should the values be stored (here <code>edge</code>)</p><p>The <code>[[inputs.mqtt_consumer]]</code> is the input plugin which will connect to a dedicated MQTT Broker mentioned in the <code>servers</code> list. The <code>topics</code> list will take care of which topics to subscribe to. Notice, we use the MQTT topic wildcard <code>+</code> to subscribe to all the IoT Node data irrespective of what the sensor’s ID is. Since the IoT Node sends data in Line Protocol Strings, we use the incoming <code>data_format = "influx"</code>. Additionally, each measurement will be stored with a tag called topic where the respective data’s MQTT <code>topic</code> will be stored a string.</p><p>In our case the IoT Node publishes data under for the following topic structure:</p><pre><code>IOT/&lt;SENSOR_ID&gt;/acc
IOT/&lt;SENSOR_ID&gt;/mag
IOT/&lt;SENSOR_ID&gt;/gyro
IOT/&lt;SENSOR_ID&gt;/temp
</code></pre><p>Once the application needs to scale, the number of unique sensor IDs increase and each measurement needs to be tagged for further processing and easily making queries like:</p><pre><code>SELECT temp FROM temperature WHERE sensorID=&quot;sensorX&quot; LIMIT 100
</code></pre><p>We let the <code>[[processors.regex]]</code> figure out what is the sensor ID from each message. We already know that the <code>[[inputs.mqtt_consumer]]</code> will store a tag called topic for each published measurement. We can leverage this and use a regular expression to tell Telegraf which string in the MQTT topic is the sensor ID.</p><p>The pattern is <code>.*/(.*)/.*</code> since we only care about the 2nd MQTT topic level which is our Sensor ID. The <code>()</code> will extract the sensor ID and store it as tag with the name <code>sensorID</code> . Hence, the following configuration:</p><div class=highlight><pre class=chroma><code class=language-toml data-lang=toml><span class=p>[[</span><span class=nx>processors</span><span class=p>.</span><span class=nx>regex</span><span class=p>]]</span>
<span class=p>[[</span><span class=nx>processors</span><span class=p>.</span><span class=nx>regex</span><span class=p>.</span><span class=nx>tags</span><span class=p>]]</span>
<span class=c># The Magic Sectionkey = &#34;topic&#34;</span>
 <span class=nx>pattern</span> <span class=p>=</span> <span class=s2>&#34;.*/(.*)/.*&#34;</span>
 <span class=nx>replacement</span> <span class=p>=</span> <span class=s2>&#34;${1}&#34;</span>
 <span class=nx>result_key</span> <span class=p>=</span> <span class=s2>&#34;sensorID&#34;</span>
</code></pre></div><h2 id=bringing-it-all-together>Bringing it all Together</h2><p>Time to spin one last container! The telegraf container with out custom configuration is executed as follows:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>docker run --name<span class=o>=</span>pitelegraf <span class=se>\
</span><span class=se></span>           -d <span class=se>\
</span><span class=se></span>           --net<span class=o>=</span>host <span class=se>\
</span><span class=se></span>           --restart<span class=o>=</span>always
           -v <span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span>/telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro <span class=se>\
</span><span class=se></span>            telegraf
</code></pre></div><p>Once this container is up and run and the IoT Node is publishing data to the IoT Edge’s MQTT Broker, the data should be available on InfluxDB.</p><p>An easy way to check is to run Chronograf on the computer within the WLAN network.</p><p>Run the binary, and in the browser enter <code>http://localhost:8888/</code></p><p>In Chronograf, go to configuration Tab on your left side and add a new connection with the IP Address of the IoT Edge’s InfluxDB.</p><p>Connect to the DB and go the Explore Tab. Once there you should be able to see <code>edge.autogen</code> database and also the <code>sensorID</code> tag for every measurement</p><figure><img src=/images/technology/iot_influxdb_docker/chronograf_dashboard_view.png><figcaption><h4>Chronograf displaying the InfluxDB Databases and Measurements with automatically created sensorID tag and visualization for them</h4></figcaption></figure><h2 id=resources>Resources</h2><p>A complete stack for the post can be now found as a <a href=https://github.com/shantanoo-desai/tiguitto target=_blank rel="noopener noreffer">GitHub Repository</a> as a <code>docker-compose.yml</code> file tested a <strong>Raspberry Pi 4 Model B</strong>.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 24-03-2020</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://shantanoo-desai.github.io/posts/technology/iot_edge_docker/ data-title="Creating your IoT Node and Edge prototype with InfluxDB, Telegraf and Docker" data-hashtags="InfluxDB,Telegraf,Docker,MQTT,IoT,docker-compose,ESP32,Raspberry Pi 4"><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://shantanoo-desai.github.io/posts/technology/iot_edge_docker/ data-hashtag=InfluxDB><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://shantanoo-desai.github.io/posts/technology/iot_edge_docker/><i class="fab fa-linkedin fa-fw"></i></a><a href=javascript:void(0); title="Share on WhatsApp" data-sharer=whatsapp data-url=https://shantanoo-desai.github.io/posts/technology/iot_edge_docker/ data-title="Creating your IoT Node and Edge prototype with InfluxDB, Telegraf and Docker" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://shantanoo-desai.github.io/posts/technology/iot_edge_docker/ data-title="Creating your IoT Node and Edge prototype with InfluxDB, Telegraf and Docker"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://shantanoo-desai.github.io/posts/technology/iot_edge_docker/><i class="fab fa-reddit fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/influxdb/>InfluxDB</a>,&nbsp;<a href=/tags/telegraf/>Telegraf</a>,&nbsp;<a href=/tags/docker/>Docker</a>,&nbsp;<a href=/tags/mqtt/>MQTT</a>,&nbsp;<a href=/tags/iot/>IoT</a>,&nbsp;<a href=/tags/docker-compose/>docker-compose</a>,&nbsp;<a href=/tags/esp32/>ESP32</a>,&nbsp;<a href=/tags/raspberry-pi-4/>Raspberry Pi 4</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/technology/nestjs_travis_docker/ class=next rel=next title="CI/CD Notes: Nest.JS + TravisCI + Docker">CI/CD Notes: Nest.JS + TravisCI + Docker<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.70.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2021</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":20},"comment":{}};</script><script type=text/javascript src=/js/theme.min.js></script></body></html>